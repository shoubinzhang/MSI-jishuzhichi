# Coze扣子平台配置指南

## 问题诊断

当前系统显示错误：`access token invalid`，这是因为 `COZE_BOT_ID` 配置不正确导致的。

## 解决步骤

### 1. 访问Coze扣子平台

访问：https://www.coze.cn/

### 2. 登录并创建工作空间

- 使用微信、手机号或邮箱登录
- 如果是首次使用，需要创建一个工作空间

### 3. 创建AI Bot

1. 在工作空间中点击「创建Bot」
2. 填写Bot基本信息：
   - Bot名称：例如「智能客服助手」
   - Bot描述：简要描述Bot的功能
   - Bot头像：可选择默认头像或上传自定义头像

### 4. 配置Bot能力

1. **人设与回复逻辑**：
   - 设置Bot的角色定位
   - 配置回复风格和语调
   - 添加专业知识背景

2. **技能配置**（可选）：
   - 添加插件功能
   - 配置知识库
   - 设置工作流

### 5. 发布Bot到API渠道（重要！）

⚠️ **关键步骤**：只有将Bot发布到API渠道，才能通过API调用

1. 在Bot配置页面点击「发布」按钮
2. 选择发布渠道时，**必须勾选「API」**
3. 完成发布流程

### 6. 获取Bot ID

发布成功后：
1. 进入Bot详情页面
2. 查看浏览器地址栏的URL
3. URL格式类似：`https://www.coze.cn/space/xxxxxxxxx/bot/123456789`
4. `bot/` 后面的数字就是Bot ID（例如：123456789）

### 7. 验证Personal Access Token

1. 在Coze平台右上角点击头像
2. 选择「个人访问令牌」
3. 检查现有令牌是否有效
4. 如果需要，创建新的令牌：
   - 输入令牌名称
   - 选择有效期（建议选择较长时间）
   - 确保令牌有足够权限

### 8. 更新环境变量

在 `server/.env` 文件中更新：

```env
# 将your_coze_bot_id_here替换为实际的Bot ID
COZE_BOT_ID=123456789

# 如果需要，也更新PAT
COZE_PAT=pat_your_actual_token_here
```

### 9. 测试配置

运行测试脚本验证配置：

```bash
cd server
node test_coze_config.js
```

## 常见问题

### Q1: 提示"access token invalid"
**解决方案**：
- 检查PAT是否正确
- 确认PAT是否已过期
- 验证PAT权限是否足够

### Q2: 提示"Bot not found"
**解决方案**：
- 确认Bot ID是否正确
- 检查Bot是否已发布到API渠道
- 验证Bot是否在当前工作空间中

### Q3: API调用成功但无回复
**解决方案**：
- 检查Bot的人设配置
- 确认Bot是否正常工作
- 查看API响应的详细信息

## 重要提醒

1. **必须发布到API渠道**：这是最容易忽略的步骤
2. **Bot ID格式**：通常是一串数字，不包含字母
3. **PAT权限**：确保令牌有调用Bot的权限
4. **网络环境**：确保能正常访问api.coze.com

## 完成后的验证

配置完成后，系统应该能够：
1. 成功创建会话
2. 正常发送和接收消息
3. 获得AI助手的智能回复

如果仍有问题，请检查服务器日志获取详细错误信息。